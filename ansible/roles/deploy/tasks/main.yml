#SPDX-License-Identifier: MIT-0
---
# tasks file for deploy - Simple et efficace
- name: Créer le répertoire de l'application
  ansible.builtin.file:
      path: "/opt/ficheqs"
      state: directory
      mode: "0755"

- name: Copier les fichiers de l'application
  copy:
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
  loop:
      - { src: "../../../../docker-compose.yml", dest: "/opt/ficheqs/docker-compose.yml" }
      - { src: "../../../../database_script.sql", dest: "/opt/ficheqs/database_script.sql" }
      - { src: "../../../../init-databases.sql", dest: "/opt/ficheqs/init-databases.sql" }

- name: Copier les répertoires backend et frontend
  copy:
      src: "{{ item }}"
      dest: "/opt/ficheqs/"
  loop:
      - "../../../../backend"
      - "../../../../frontend"

- name: Arrêter tous les conteneurs existants
  command: docker compose -f /opt/ficheqs/docker-compose.yml down
  args:
      chdir: "/opt/ficheqs"
  ignore_errors: yes

- name: Démarrer tous les services
  command: docker compose -f /opt/ficheqs/docker-compose.yml up -d --build
  args:
      chdir: "/opt/ficheqs"
  environment:
      NODE_ENV: "{{ node_env }}"
      DB_USER: "{{ db_user }}"
      DB_PASSWORD: "{{ db_password }}"
      EMAIL: "{{ email }}"
      MAILJET_API_KEY: "{{ mailjet_api_key }}"
      MAILJET_SECRET_KEY: "{{ mailjet_secret_key }}"
      JWT_SECRET: "{{ secrets.JWT_SECRET }}"
      JWT_SECRET_H76: "{{ secrets.JWT_SECRET }}"
      JWT_SECRET_DEMO: "{{ secrets.JWT_SECRET_DEMO }}"
      ORIGIN_URL_H76: "{{ secrets.ORIGIN_URL_H76 }}"
      SERVER_URL_H76: "{{ secrets.SERVER_URL_H76 }}"
      ORIGIN_URL_DEMO: "{{ secrets.ORIGIN_URL_DEMO }}"
      SERVER_URL_DEMO: "{{ secrets.SERVER_URL_DEMO }}"

- name: Attendre que les services soient prêts
  wait_for:
      port: "{{ item }}"
      host: localhost
      delay: 5
      timeout: 60
  loop:
      - 5432 # PostgreSQL
      - 3001 # Backend H76
      - 3002 # Backend Demo
      - 8080 # Frontend H76
      - 8081 # Frontend Demo
